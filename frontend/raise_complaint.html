<!DOCTYPE html>
<html>
<head>
<title>Raise Complaint | HCMS</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<script>
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role !== "student") {
  window.location.href = "login.html";
}
</script>

<div class="container mt-5">
  <div class="card shadow p-4">
    <h4 class="fw-bold mb-3">Raise Complaint</h4>

    <input class="form-control mb-2" id="student_name" placeholder="Student Name">
    <input class="form-control mb-2" id="room_number" placeholder="Room Number">
    <input class="form-control mb-2" id="hostel_name" placeholder="Hostel Name">
    <input class="form-control mb-2" id="phone_number" placeholder="Phone Number">
    <input class="form-control mb-2" id="title" placeholder="Complaint Title">
    <textarea class="form-control mb-3" id="description" rows="4"
      placeholder="Complaint Description"></textarea>

    <input type="file" id="image" class="form-control mb-2" accept="image/*" onchange="previewImage(event)">

    <div class="text-center mb-3">
      <img id="preview" src="" style="max-width:250px; display:none; border-radius:10px;" />
    </div>

    <button class="btn btn-primary w-100" onclick="submitComplaint()">Submit</button>
  </div>
</div>

<script>
function submitComplaint() {
  const formData = new FormData();

  formData.append("title", title.value);
  formData.append("description", description.value);
  formData.append("image", image.files[0]);

  fetch("https://hcms-backend.onrender.com/api/complaints/raise/", {
    method: "POST",
    headers: {
      "Authorization": "Token " + token
    },
    body: formData
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to submit");
    return res.json();
  })
  .then(() => {
    alert("Complaint submitted successfully");
    window.location.href = "student_dashboard.html";
  })
  .catch(err => alert(err.message));
}

function previewImage(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('preview');
  if (!file) {
    preview.style.display = 'none';
    preview.src = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    preview.src = e.target.result;
    preview.style.display = 'block';
  }
  reader.readAsDataURL(file);
}
</script>

</body>
</html>
