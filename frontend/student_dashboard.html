<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard | HCMS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      border-radius: 14px;
    }
  </style>
</head>

<body>

<script>
/* üîê AUTH + ROLE CHECK */
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role !== "student") {
  window.location.href = "login.html";
}
</script>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-primary px-4">
  <span class="navbar-brand fw-bold">HCMS ‚Äì Student</span>
  <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
</nav>

<!-- CONTENT -->
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">My Complaints</h4>
    <a href="raise_complaint.html" class="btn btn-primary btn-sm">
      + Raise Complaint
    </a>
  </div>

  <div id="complaints"></div>
</div>

<script>
const complaintsDiv = document.getElementById("complaints");

/* üì° FETCH COMPLAINTS */
fetch("http://127.0.0.1:8000/api/complaints/list/", {
  headers: {
    "Authorization": "Token " + token
  }
})
.then(res => {
  if (!res.ok) throw new Error("Failed to fetch complaints");
  return res.json();
})
.then(data => {

  if (data.length === 0) {
    complaintsDiv.innerHTML =
      "<p class='text-muted text-center'>No complaints submitted yet.</p>";
    return;
  }

  complaintsDiv.innerHTML = data.map(c => `
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h6 class="fw-bold">${escapeHtml(c.title)}</h6>
        <p class="mb-2">${escapeHtml(c.description)}</p>
        <span class="badge bg-${c.status === 'Resolved' ? 'success' : 'warning'}">
          ${escapeHtml(c.status)}
        </span>
      </div>
    </div>
  `).join("");
})
.catch(err => {
  complaintsDiv.innerHTML =
    `<p class='text-danger text-center'>${err.message}</p>`;
});

/* üîê LOGOUT */
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

/* üîí XSS SAFE */
function escapeHtml(text) {
  if (!text) return "";
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
  return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

</body>
</html>
